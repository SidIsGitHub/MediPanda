<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>MediPanda</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com">
        const deviceId = "user_" + Math.random().toString(36).substr(2, 9);
        // Generate a unique ID for this phone
        if (!deviceId) {
            deviceId = "user_" + Math.random().toString(36).substr(2, 9);
            localStorage.setItem("paws_device_id", deviceId);
        }
        console.log("My User ID:", deviceId);
    </script>

    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

    <style>
        body {
            font-family: "Inter", sans-serif;
        }

        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;
            /* IE and Edge */
            scrollbar-width: none;
            /* Firefox */
        }

        /* The iOS-style Spring Animation */
        .ios-spring {
            transition: all 0.6s cubic-bezier(0.19, 1, 0.22, 1);
            /* Apple's "Spring" curve */
        }

        .fade-enter {
            opacity: 0;
            transform: scale(0.9);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }

        .fade-enter-active {
            opacity: 1;
            transform: scale(1);
        }

        /* --- ADD THESE NEW STYLES INSIDE YOUR EXISTING <style> TAG --- */

        /* 1. Dark Mode Base */
        body {
            background-color: #09090b;
            color: #ffffff;
            /* White text by default */
        }

        /* 2. Apple Music Style Animated Gradients */
        .animated-gradient-1 {
            background: linear-gradient(135deg, #ff4b1f, #ff9068);
            background-size: 200% 200%;
            animation: gradientMove 6s ease infinite;
        }

        .animated-gradient-2 {
            background: linear-gradient(135deg, #8E2DE2, #4A00E0);
            background-size: 200% 200%;
            animation: gradientMove 8s ease infinite;
        }

        @keyframes gradientMove {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        /* 3. Utility to hide scrollbars for a cleaner look */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* iOS-style Fluid Expansion */
        .app-transition {
            transition:
                top 0.5s cubic-bezier(0.32, 0.72, 0, 1),
                left 0.5s cubic-bezier(0.32, 0.72, 0, 1),
                width 0.5s cubic-bezier(0.32, 0.72, 0, 1),
                height 0.5s cubic-bezier(0.32, 0.72, 0, 1),
                border-radius 0.5s cubic-bezier(0.32, 0.72, 0, 1),
                opacity 0.2s ease-out;
            /* Faster fade for the container itself */
            position: fixed;
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.75);
            /* Deeper shadow during flight */
        }

        /* Content Fade Logic - The Secret to Smoothness */
        .content-hidden {
            opacity: 0;
            transform: scale(0.98);
            /* Slight zoom out effect */
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
        }

        .content-visible {
            opacity: 1;
            transform: scale(1);
            /* Delay fade-in until card is mostly open (0.3s delay) */
            transition: opacity 0.4s ease-out 0.3s, transform 0.4s ease-out 0.3s;
        }
    </style>
</head>

<body class="h-[100dvh] flex flex-col overflow-hidden bg-[#121212]">
    <div id="auth-screen"
        class="fixed inset-0 z-[100] bg-black flex flex-col justify-center items-center p-6 transition-all duration-500">
        <div class="w-full max-w-sm h-full max-h-[90vh] flex flex-col">
            <div class="text-center mb-6 flex-shrink-0">
                <h1 class="text-4xl font-extrabold text-white tracking-tight mb-2">MediPanda</h1>
                <p class="text-zinc-400">Your Personal AI Health Companion</p>
            </div>

            <div class="bg-zinc-900 border border-zinc-800 rounded-3xl shadow-2xl flex flex-col overflow-hidden flex-1">

                <div class="flex bg-zinc-800 p-1 m-4 rounded-xl flex-shrink-0">
                    <button onclick="toggleAuthMode('login')" id="tab-login"
                        class="flex-1 py-2 text-sm font-bold rounded-lg bg-zinc-600 text-white transition-all">Log
                        In</button>
                    <button onclick="toggleAuthMode('register')" id="tab-register"
                        class="flex-1 py-2 text-sm font-bold rounded-lg text-zinc-400 hover:text-white transition-all">Sign
                        Up</button>
                </div>

                <div id="auth-scroll-area" class="overflow-y-auto px-6 pb-6 space-y-4 no-scrollbar flex-1">

                    <div id="register-avatar" class="hidden flex-col items-center justify-center mb-4">
                        <div class="relative group cursor-pointer"
                            onclick="document.getElementById('reg-photo-input').click()">
                            <div id="reg-photo-preview"
                                class="w-24 h-24 rounded-full bg-zinc-800 border-2 border-zinc-700 overflow-hidden flex items-center justify-center object-cover">
                                <i class="fa-solid fa-camera text-2xl text-zinc-500"></i>
                            </div>
                            <div
                                class="absolute bottom-0 right-0 bg-blue-600 w-8 h-8 rounded-full flex items-center justify-center border-2 border-black">
                                <i class="fa-solid fa-plus text-white text-xs"></i>
                            </div>
                        </div>
                        <p class="text-zinc-500 text-xs mt-2">Tap to upload photo</p>
                        <input type="file" id="reg-photo-input" accept="image/*" class="hidden"
                            onchange="previewRegPhoto(this)">
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="text-xs font-bold text-zinc-500 uppercase ml-2">Email</label>
                            <input type="email" id="auth-email"
                                class="w-full bg-black text-white p-4 rounded-2xl border border-zinc-700 outline-none focus:border-blue-500 transition"
                                placeholder="name@example.com">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-zinc-500 uppercase ml-2">Password</label>
                            <input type="password" id="auth-password"
                                class="w-full bg-black text-white p-4 rounded-2xl border border-zinc-700 outline-none focus:border-blue-500 transition"
                                placeholder="••••••••">
                        </div>
                    </div>

                    <div id="register-fields" class="hidden space-y-4 pt-2 border-t border-zinc-800 mt-4">
                        <h3 class="text-white font-bold text-sm">Medical Profile</h3>

                        <div class="flex gap-3">
                            <div class="flex-1">
                                <label class="text-xs font-bold text-zinc-500 uppercase ml-2">First Name</label>
                                <input type="text" id="reg-firstname"
                                    class="w-full bg-black text-white p-4 rounded-2xl border border-zinc-700 outline-none focus:border-blue-500"
                                    placeholder="Siddhant">
                            </div>
                            <div class="flex-1">
                                <label class="text-xs font-bold text-zinc-500 uppercase ml-2">Last Name</label>
                                <input type="text" id="reg-lastname"
                                    class="w-full bg-black text-white p-4 rounded-2xl border border-zinc-700 outline-none focus:border-blue-500"
                                    placeholder="Bansod">
                            </div>
                        </div>

                        <div class="flex gap-3">
                            <div class="flex-1">
                                <label class="text-xs font-bold text-zinc-500 uppercase ml-2">Age</label>
                                <input type="number" id="reg-age"
                                    class="w-full bg-black text-white p-4 rounded-2xl border border-zinc-700 outline-none focus:border-blue-500"
                                    placeholder="25">
                            </div>
                            <div class="flex-1">
                                <label class="text-xs font-bold text-zinc-500 uppercase ml-2">Blood</label>
                                <select id="reg-blood"
                                    class="w-full bg-black text-white p-4 rounded-2xl border border-zinc-700 outline-none appearance-none focus:border-blue-500">
                                    <option value="Unknown">--</option>
                                    <option value="A+">A+</option>
                                    <option value="O+">O+</option>
                                    <option value="B+">B+</option>
                                    <option value="AB+">AB+</option>
                                    <option value="A-">A-</option>
                                    <option value="O-">O-</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="text-xs font-bold text-zinc-500 uppercase ml-2">Dietary Goal</label>
                            <div class="relative">
                                <select id="reg-goal"
                                    class="w-full bg-black text-white p-4 rounded-2xl border border-zinc-700 outline-none appearance-none focus:border-blue-500">
                                    <option value="Maintain">Maintain Weight</option>
                                    <option value="Weight Loss">Weight Loss</option>
                                    <option value="Aggressive Weight Loss">Aggressive Weight Loss</option>
                                    <option value="Weight Gain">Weight Gain</option>
                                    <option value="Aggressive Weight Gain">Aggressive Weight Gain</option>
                                </select>
                                <div
                                    class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-zinc-500">
                                    <i class="fa-solid fa-chevron-down text-xs"></i>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="text-xs font-bold text-zinc-500 uppercase ml-2">Location</label>
                            <div class="relative flex items-center">
                                <input type="text" id="reg-location"
                                    class="w-full bg-black text-white p-4 pr-12 rounded-2xl border border-zinc-700 outline-none focus:border-blue-500"
                                    placeholder="Detecting..." readonly>

                                <button onclick="detectUserLocation()"
                                    class="absolute right-2 top-2 bottom-2 bg-zinc-800 hover:bg-zinc-700 text-blue-500 w-10 rounded-xl flex items-center justify-center transition-colors border border-zinc-600">
                                    <i class="fa-solid fa-location-crosshairs"></i>
                                </button>
                            </div>
                            <p class="text-[10px] text-zinc-500 ml-2 mt-1">*Tap icon to detect automatically</p>
                        </div>

                        <div>
                            <label class="text-xs font-bold text-zinc-500 uppercase ml-2">Conditions</label>
                            <div class="relative"> <label class="text-xs font-bold text-zinc-500 uppercase ml-2">Chronic
                                    Conditions</label>

                                <div class="w-full bg-black min-h-[60px] p-2 rounded-2xl border border-zinc-700 focus-within:border-blue-500 transition flex flex-wrap gap-2"
                                    onclick="document.getElementById('condition-search').focus()">

                                    <div id="conditions-container" class="contents"></div>

                                    <input type="text" id="condition-search"
                                        class="bg-transparent text-white outline-none flex-1 min-w-[120px] p-2 placeholder-zinc-600"
                                        placeholder="Search (e.g. Asthma)" autocomplete="off">
                                </div>

                                <div id="suggestions-box"
                                    class="hidden absolute top-full left-0 w-full bg-zinc-800 border border-zinc-700 rounded-xl mt-2 overflow-hidden shadow-2xl max-h-40 overflow-y-auto z-[101]">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="pt-4 pb-2">
                        <button onclick="handleAuth()" id="auth-action-btn"
                            class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition-all">
                            Log In
                        </button>
                        <button onclick="bypassAuth()"
                            class="w-full mt-3 py-3 text-zinc-500 text-xs font-bold hover:text-white transition">
                            Continue as Guest (Demo)
                        </button>
                        <p id="auth-error" class="text-red-500 text-xs text-center font-bold mt-2"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="google-places-service" style="display:none;"></div>
    <button onclick="showScreen('profile')"
        class="absolute top-6 right-6 z-50 w-14 h-14 bg-zinc-800 rounded-full shadow-xl flex items-center justify-center active:scale-90 transition-transform border border-zinc-700">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24"
            stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
        </svg>
    </button>

    <div id="profile-modal"
        class="fixed inset-0 bg-black/60 z-[60] backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-300 flex items-end">
        <div
            class="bg-white w-full rounded-t-[32px] p-8 pb-12 translate-y-full transition-transform duration-500 shadow-2xl">
            <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-6"></div>
            <h2 class="text-2xl font-extrabold text-slate-800 mb-2">My Health Profile</h2>
            <p class="text-slate-500 text-sm mb-6">Tell Dr. Paws about allergies or conditions (e.g., "I am diabetic").
            </p>

            <textarea id="medical-input"
                class="w-full bg-slate-100 border-none rounded-2xl p-4 h-32 text-slate-700 placeholder-slate-400 focus:ring-2 focus:ring-blue-500 outline-none transition-all"
                placeholder="Ex: Peanut allergy, high blood pressure..."></textarea>

            <button onclick="saveAndCloseProfile()"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-2xl mt-6 shadow-lg active:scale-95 transition-all">
                Save Profile
            </button>
            <button onclick="toggleProfile(false)" class="w-full text-slate-400 font-bold py-4 mt-2">Close</button>
        </div>
    </div>

    <div id="dynamic-island"
        class="absolute top-6 left-1/2 -translate-x-1/2 z-50 bg-black shadow-2xl ios-spring overflow-hidden cursor-pointer group"
        style="width: 200px; height: 64px; border-radius: 9999px;" onclick="expandCamera()">

        <div id="camera-icon" class="absolute inset-0 flex items-center justify-center transition-opacity duration-250">
            <svg xmlns="http://www.w3.org/2000/svg"
                class="h-8 w-8 text-white group-hover:scale-110 transition-transform" fill="none" viewBox="0 0 24 24"
                stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        </div>

        <div id="camera-view"
            class="absolute inset-0 opacity-0 pointer-events-none transition-opacity duration-500 delay-100 flex flex-col">

            <div class="absolute top-4 right-4 z-20 bg-black/50 rounded-full p-2 backdrop-blur-md"
                onclick="collapseCamera(event)">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20"
                    fill="currentColor">
                    <path fill-rule="evenodd"
                        d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                        clip-rule="evenodd" />
                </svg>
            </div>

            <video id="camera-stream" autoplay playsinline class="w-full h-full object-cover"></video>

            <div class="absolute bottom-6 w-full text-center">
                <p
                    class="text-white font-medium text-sm bg-black/30 backdrop-blur-md inline-block px-4 py-1 rounded-full border border-white/20">
                    Scanning
                </p>
            </div>
        </div>
    </div>

    <input type="file" id="camera-input" accept="image/*" capture="environment" class="hidden">

    <div id="home-screen" class="flex-1 flex flex-col p-6 space-y-6 overflow-y-auto no-scrollbar pb-32">
        <h1 class="text-3xl font-extrabold mt-20 tracking-tight">Good Evening,<br><span
                class="text-zinc-400">Siddhant</span></h1>
        <div class="grid grid-cols-2 gap-4 h-56">
            <div
                class="animated-gradient-1 rounded-3xl p-5 flex flex-col justify-between shadow-lg relative overflow-hidden">
                <i class="fa-solid fa-bolt absolute top-5 right-5 text-2xl opacity-70"></i>
                <div></div>
                <h2 class="text-2xl font-bold relative z-10 leading-tight">Quick<br>Actions</h2>
            </div>
            <div id="care-card" onclick="openMapModal()"
                class="relative rounded-3xl overflow-hidden shadow-lg border border-zinc-800 bg-zinc-900 h-56 cursor-pointer active:scale-95 transition-transform duration-300 group">

                <div id="static-map-preview"
                    class="absolute inset-0 z-0 opacity-60 grayscale group-hover:grayscale-0 transition-all duration-500">
                </div>

                <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent z-10"></div>

                <div class="relative z-20 h-full p-5 flex flex-col justify-between">
                    <div></div>
                    <div class="flex flex-col">
                        <h2 class="text-white font-bold text-2xl leading-tight tracking-tight">Care &<br>Connect</h2>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-zinc-900 rounded-3xl p-6 h-48 relative overflow-hidden border border-zinc-800 flex items-center">
            <div class="max-w-[65%] z-10">
                <h3 class="font-bold text-xl mb-2 text-white"><i class="fa-solid fa-paw mr-2"></i>Dr. Paws Tip</h3>
                <p class="text-zinc-400 leading-relaxed">"Bamboo is great, but variety is better! Try adding colorful
                    veggies to your next meal."</p>
            </div>
            <img src="https://cdn-icons-png.flaticon.com/512/3769/3769036.png"
                class="absolute -right-6 -bottom-10 w-48 opacity-90 rotate-12 drop-shadow-2xl" alt="Mascot Peeking">
        </div>
    </div>
    <div id="profile-screen" class="hidden h-full flex flex-col bg-[#000000] overflow-y-auto no-scrollbar pb-40">

        <div class="p-6 pt-12 flex justify-between items-center sticky top-0 bg-black/80 backdrop-blur-md z-20">
            <h1 class="text-3xl font-extrabold text-white tracking-tight">Medical ID</h1>
            <button onclick="saveAndCloseProfile()" class="text-blue-500 font-bold text-lg">Done</button>
        </div>

        <div class="flex flex-col items-center mt-2 mb-8">
            <div class="relative group cursor-pointer">
                <div
                    class="w-24 h-24 rounded-full bg-zinc-800 border-2 border-zinc-700 overflow-hidden flex items-center justify-center">
                    <i class="fa-solid fa-user text-4xl text-zinc-500"></i>
                </div>
                <div
                    class="absolute bottom-0 right-0 bg-blue-600 w-8 h-8 rounded-full flex items-center justify-center border-2 border-black">
                    <i class="fa-solid fa-camera text-xs text-white"></i>
                </div>
            </div>
            <button class="mt-3 text-blue-500 text-sm font-medium">Edit Photo</button>
        </div>

        <div class="px-5 space-y-8">

            <div>
                <h3 class="text-zinc-500 text-xs font-bold uppercase ml-4 mb-2">Basic Info</h3>
                <div class="bg-[#1c1c1e] rounded-xl overflow-hidden">
                    <div class="flex items-center justify-between p-4 border-b border-zinc-800">
                        <span class="text-white">Name</span>
                        <input type="text" id="p-name" placeholder="Your Name"
                            class="bg-transparent text-right text-zinc-400 placeholder-zinc-600 outline-none w-1/2 focus:text-blue-500">
                    </div>
                    <div class="flex border-b border-zinc-800">
                        <div class="flex-1 flex items-center justify-between p-4 border-r border-zinc-800">
                            <span class="text-white">Age</span>
                            <input type="number" id="p-age" placeholder="--"
                                class="bg-transparent text-right text-zinc-400 outline-none w-12">
                        </div>
                        <div class="flex-1 flex items-center justify-between p-4">
                            <span class="text-white">Blood</span>
                            <select id="p-blood"
                                class="bg-transparent text-right text-zinc-400 outline-none appearance-none">
                                <option value="Unknown">--</option>
                                <option value="A+">A+</option>
                                <option value="O+">O+</option>
                                <option value="B+">B+</option>
                                <option value="AB+">AB+</option>
                                <option value="A-">A-</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex items-center justify-between p-4 border-b border-zinc-800">
                        <span class="text-white">Height (cm)</span>
                        <input type="number" id="p-height" placeholder="--"
                            class="bg-transparent text-right text-zinc-400 outline-none w-20">
                    </div>
                    <div class="flex items-center justify-between p-4">
                        <span class="text-white">Weight (kg)</span>
                        <input type="number" id="p-weight" placeholder="--"
                            class="bg-transparent text-right text-zinc-400 outline-none w-20">
                    </div>
                </div>
            </div>

            <div>
                <h3 class="text-zinc-500 text-xs font-bold uppercase ml-4 mb-2">Health Conditions</h3>
                <div class="bg-[#1c1c1e] rounded-xl p-4">
                    <textarea id="p-conditions" rows="3"
                        class="w-full bg-transparent text-white placeholder-zinc-600 outline-none resize-none"
                        placeholder="Ex: Type 2 Diabetes, Asthma, Peanut Allergy..."></textarea>
                </div>
            </div>

            <div>
                <h3 class="text-zinc-500 text-xs font-bold uppercase ml-4 mb-2">Active Medications</h3>
                <div class="bg-[#1c1c1e] rounded-xl p-4">
                    <textarea id="p-meds" rows="3"
                        class="w-full bg-transparent text-white placeholder-zinc-600 outline-none resize-none"
                        placeholder="Ex: Metformin (Morning), Insulin (Night)..."></textarea>
                </div>
            </div>

            <div>
                <h3 class="text-zinc-500 text-xs font-bold uppercase ml-4 mb-2">Goals & Location</h3>
                <div class="bg-[#1c1c1e] rounded-xl overflow-hidden">
                    <div class="flex items-center justify-between p-4 border-b border-zinc-800">
                        <span class="text-white">Dietary Goal</span>
                        <input type="text" id="p-goal" placeholder="Lose weight / Gain muscle"
                            class="bg-transparent text-right text-zinc-400 outline-none w-1/2">
                    </div>
                    <div class="flex items-center justify-between p-4">
                        <span class="text-white">Location</span>
                        <input type="text" id="p-location" placeholder="City, Country"
                            class="bg-transparent text-right text-zinc-400 outline-none w-1/2">
                    </div>
                </div>
            </div>

            <p class="text-center text-zinc-600 text-xs px-8">This information is shared with Dr. Paws to provide
                personalized health advice.</p>
        </div>
    </div>
    <div id="chat-screen" class="hidden flex-1 flex flex-col bg-zinc-950">
        <div id="chat-container" class="flex-1 overflow-y-auto p-4 pb-32 space-y-4">
            <div class="flex justify-start">
                <div
                    class="bg-zinc-800 text-gray-200 p-3 rounded-2xl rounded-tl-none max-w-[80%] border border-zinc-700 shadow-sm text-sm">
                    Hello! I'm Dr. Paws. Ask me anything!
                </div>
            </div>
        </div>
        <div class="w-full bg-zinc-900 border-t border-zinc-800 p-4 pb-28">
            <div class="flex items-center gap-3">

                <button onclick="document.getElementById('camera-input').click()"
                    class="text-zinc-400 hover:text-white transition">
                    <i class="fa-solid fa-camera"></i>
                </button>

                <input type="text" id="user-input"
                    class="flex-1 bg-zinc-800 text-white rounded-full px-5 py-3 outline-none border border-zinc-700 focus:border-blue-500 transition placeholder-zinc-500"
                    placeholder="Ask Dr. Paws..." onkeypress="if(event.key === 'Enter') sendMessage()">

                <button onclick="sendMessage()"
                    class="bg-blue-600 text-white w-12 h-12 rounded-full hover:bg-blue-500 transition shadow-lg active:scale-90 flex items-center justify-center flex-shrink-0">
                    <i class="fa-solid fa-paper-plane text-sm"></i>
                </button>
            </div>
        </div>
    </div>
    </div>

    <script>
        // --- 1. CONFIGURATION & SAFETY GLOBALS ---
        mapboxgl.accessToken = 'pk.eyJ1Ijoic2lkZGhhbnRiYW5zb2QiLCJhIjoiY21raWJ5amo2MHI3cjNlcXhwY2RmZHlhNiJ9.AmRwXlI_MuxXn7x2PR7IAg';

        let mapInstance = null;
        let markers = [];
        let userLat = 19.0330;
        let userLng = 73.0297;
        let currentUser = null; // Holds the logged-in user (or guest)

        // --- 2. AUTHENTICATION & REGISTRATION LOGIC ---
        //localStorage.removeItem('paws_guest_profile'); location.reload();
        // Global Variables
        let authMode = 'login';
        let uploadedPhotoBase64 = null; // To store the image string

        window.addEventListener('load', () => {
            initPreview();
            // Check for saved user (Guest or Supabase)
            const guestData = localStorage.getItem('paws_guest_profile');
            if (guestData) {
                currentUser = { isGuest: true, data: JSON.parse(guestData) };
                // Auto-load profile picture if exists
                if (currentUser.data.photo) updateProfilePhotoUI(currentUser.data.photo);
                // Hide auth screen
                document.getElementById('auth-screen').classList.add('hidden');
                updateUIWithProfile(currentUser.data);
            }
        });

        // A. Toggle between Simple Login and Big Register Form
        function toggleAuthMode(mode) {
            authMode = mode;
            const btn = document.getElementById('auth-action-btn');
            const tabLogin = document.getElementById('tab-login');
            const tabRegister = document.getElementById('tab-register');
            const regFields = document.getElementById('register-fields');
            const regAvatar = document.getElementById('register-avatar');

            if (mode === 'login') {
                btn.innerText = "Log In";
                tabLogin.className = "flex-1 py-2 text-sm font-bold rounded-lg bg-zinc-600 text-white transition-all";
                tabRegister.className = "flex-1 py-2 text-sm font-bold rounded-lg text-zinc-400 hover:text-white transition-all";
                regFields.classList.add('hidden');
                regAvatar.classList.add('hidden');
            } else {
                btn.innerText = "Create Profile";
                tabRegister.className = "flex-1 py-2 text-sm font-bold rounded-lg bg-zinc-600 text-white transition-all";
                tabLogin.className = "flex-1 py-2 text-sm font-bold rounded-lg text-zinc-400 hover:text-white transition-all";
                regFields.classList.remove('hidden');
                regAvatar.classList.remove('hidden'); // Show photo uploader
                regAvatar.classList.add('flex');
            }
        }

        // B. Handle Photo Preview (Converts to Base64)
        function previewRegPhoto(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    uploadedPhotoBase64 = e.target.result; // Save string
                    const previewDiv = document.getElementById('reg-photo-preview');
                    previewDiv.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover">`;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // C. Update Profile Photo Everywhere
        function updateProfilePhotoUI(base64String) {
            if (!base64String) return;

            // 1. Home Screen Profile Button
            const homeBtn = document.querySelector('button[onclick="showScreen(\'profile\')"]');
            if (homeBtn) {
                homeBtn.innerHTML = `<img src="${base64String}" class="w-full h-full object-cover rounded-full border border-zinc-600">`;
            }

            // 2. Profile Screen Large Avatar
            const profileAvatar = document.querySelector('#profile-screen .w-24.h-24'); // Target the big circle
            if (profileAvatar) {
                profileAvatar.innerHTML = `<img src="${base64String}" class="w-full h-full object-cover">`;
                profileAvatar.classList.remove('bg-zinc-800'); // Remove gray background
            }
        }

        // D. Main Handle Auth (Login OR Register)
        async function handleAuth() {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const errorMsg = document.getElementById('auth-error');
            const btn = document.getElementById('auth-action-btn');

            errorMsg.innerText = "";

            // 1. LOGIN MODE
            if (authMode === 'login') {
                if (!email || !password) { errorMsg.innerText = "Please enter email & password."; return; }
                // For demo, we just simulate login or bypass
                bypassAuth();
                return;
            }

            // 2. REGISTER MODE (The Big Save)
            if (authMode === 'register') {
                const fname = document.getElementById('reg-firstname').value.trim();
                const lname = document.getElementById('reg-lastname').value.trim();

                if (!fname || !lname) {
                    errorMsg.innerText = "First and Last Name are required.";
                    return;
                }

                btn.innerText = "Creating Profile...";

                // Combine Names
                const fullName = `${fname} ${lname}`;

                const newProfile = {
                    id: "user_" + Math.random().toString(36).substr(2, 9),
                    email: email,
                    full_name: fullName, // Saved as one string for display
                    first_name: fname,   // Saved separately for logic
                    last_name: lname,
                    age: document.getElementById('reg-age').value,
                    blood_group: document.getElementById('reg-blood').value,
                    conditions: selectedConditions.join(", "),
                    // Meds are optional, no check needed
                    medications: document.getElementById('reg-meds') ? document.getElementById('reg-meds').value : "",
                    dietary_goal: document.getElementById('reg-goal').value, // Gets value from dropdown
                    location: document.getElementById('reg-location').value,
                    photo: uploadedPhotoBase64,
                    joined_at: new Date()
                };

                // SAVE DATA (Simulate Database Insert)
                try {
                    // A. Save to Local Storage (Guest DB)
                    localStorage.setItem('paws_guest_profile', JSON.stringify(newProfile));

                    // B. If Supabase was active, we would run: 
                    // await supabase.from('profiles').insert([newProfile]);

                    // C. Update App State
                    currentUser = { isGuest: true, data: newProfile };
                    updateUIWithProfile(newProfile); // Update text fields
                    updateProfilePhotoUI(newProfile.photo); // Update images

                    // D. Success Transition
                    setTimeout(() => {
                        document.getElementById('auth-screen').classList.add('hidden');
                        alert("Welcome, " + newProfile.full_name + "!");
                    }, 800);

                } catch (e) {
                    errorMsg.innerText = "Error saving profile. Try again.";
                    btn.innerText = "Create Profile";
                }
            }
        }

        // E. Update UI Text Fields (Helper)
        function updateUIWithProfile(data) {
            if (data.full_name) {
                // Home Header
                const headerName = document.querySelector('h1 span');
                if (headerName) headerName.innerText = data.full_name.split(' ')[0];

                // Profile Modal Inputs
                const pName = document.getElementById('p-name');
                if (pName) pName.value = data.full_name;
            }
            if (data.age) document.getElementById('p-age').value = data.age;
            if (data.blood_group) document.getElementById('p-blood').value = data.blood_group;
            if (data.conditions) document.getElementById('p-conditions').value = data.conditions;
            if (data.medications) document.getElementById('p-meds').value = data.medications;
            if (data.dietary_goal) document.getElementById('p-goal').value = data.dietary_goal;
            if (data.location) document.getElementById('p-location').value = data.location;
        }

        // Keep existing bypassAuth for the "Guest" button
        function bypassAuth() {
            currentUser = { id: "guest", isGuest: true };
            document.getElementById('auth-screen').classList.add('hidden');

            // Attempt to load existing data
            const savedData = localStorage.getItem('paws_guest_profile');
            if (savedData) {
                const data = JSON.parse(savedData);
                updateUIWithProfile(data);
                if (data.photo) updateProfilePhotoUI(data.photo);
            }
        }
        // --- LOCATION DETECTION LOGIC ---
        async function detectUserLocation() {
            const locInput = document.getElementById('reg-location');
            const icon = event.currentTarget.querySelector('i');

            // Visual Feedback
            locInput.value = "Locating...";
            icon.className = "fa-solid fa-spinner fa-spin";

            if (!navigator.geolocation) {
                alert("Geolocation is not supported by your browser");
                locInput.value = "";
                return;
            }

            navigator.geolocation.getCurrentPosition(async (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;

                // Use Mapbox Reverse Geocoding to get City Name
                const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${lng},${lat}.json?types=place&access_token=${mapboxgl.accessToken}`;

                try {
                    const response = await fetch(url);
                    const data = await response.json();

                    if (data.features && data.features.length > 0) {
                        // Found the city!
                        locInput.value = data.features[0].text;
                    } else {
                        // Fallback if Mapbox fails to find city name
                        locInput.value = `${lat.toFixed(2)}, ${lng.toFixed(2)}`;
                    }
                } catch (e) {
                    console.error(e);
                    locInput.value = "Unknown Location";
                }

                // Reset Icon
                icon.className = "fa-solid fa-location-crosshairs";

            }, () => {
                alert("Unable to retrieve your location. Please type it manually.");
                locInput.value = "";
                locInput.readOnly = false; // Let user type if GPS fails
                icon.className = "fa-solid fa-location-crosshairs";
            });
        }
        // --- MEDICAL CONDITION TAGGING SYSTEM (Fixed) ---

const MASTER_CONDITIONS = [
    "Type 1 Diabetes", "Type 2 Diabetes", "Hypertension (High BP)", 
    "Asthma", "Peanut Allergy", "Shellfish Allergy", "Lactose Intolerance",
    "Gluten Sensitivity", "Celiac Disease", "Epilepsy", 
    "Migraine", "Thyroid Disorder", "Arthritis", 
    "Heart Disease", "Kidney Disease", "None"
];

let selectedConditions = [];

// Re-attach listeners whenever we switch to Register mode
function attachConditionListeners() {
    const input = document.getElementById('condition-search');
    const suggestionBox = document.getElementById('suggestions-box');
    
    if (!input || !suggestionBox) return;

    // Clear old listeners to avoid duplicates (clone node trick)
    const newInput = input.cloneNode(true);
    input.parentNode.replaceChild(newInput, input);
    
    // Attach 'Input' Event
    newInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        
        if (query.length < 1) {
            suggestionBox.classList.add('hidden');
            return;
        }

        const matches = MASTER_CONDITIONS.filter(c => 
            c.toLowerCase().includes(query) && !selectedConditions.includes(c)
        );

        if (matches.length > 0) {
            suggestionBox.innerHTML = matches.map(c => `
                <div onclick="addConditionTag('${c}')" 
                     class="p-3 hover:bg-zinc-700 text-white cursor-pointer border-b border-zinc-700/50 last:border-0 transition text-sm font-medium">
                    ${c}
                </div>
            `).join('');
            suggestionBox.classList.remove('hidden');
        } else {
            suggestionBox.classList.add('hidden');
        }
    });

    // Re-focus helper
    newInput.addEventListener('blur', () => {
        // Delay hiding so clicks register
        setTimeout(() => suggestionBox.classList.add('hidden'), 200);
    });
}

// Add Tag
function addConditionTag(condition) {
    if (selectedConditions.includes(condition)) return;
    selectedConditions.push(condition);
    renderTags();
    
    const input = document.getElementById('condition-search');
    input.value = "";
    document.getElementById('suggestions-box').classList.add('hidden');
    input.focus();
}

// Remove Tag
function removeConditionTag(condition) {
    selectedConditions = selectedConditions.filter(c => c !== condition);
    renderTags();
}

// Render Blue Chips
function renderTags() {
    const container = document.getElementById('conditions-container');
    container.innerHTML = selectedConditions.map(c => `
        <div class="bg-blue-600/20 border border-blue-500/50 text-blue-400 px-3 py-1.5 rounded-lg flex items-center gap-2 text-sm font-medium animate-fade-in">
            <span>${c}</span>
            <button onclick="removeConditionTag('${c}')" class="hover:text-white transition">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
    `).join('');
}

// --- UPDATE TOGGLE FUNCTION ---
// Update your existing toggleAuthMode function to call attachConditionListeners()
const originalToggle = toggleAuthMode; // Store old ref if needed, or just overwrite:

function toggleAuthMode(mode) {
    authMode = mode;
    const btn = document.getElementById('auth-action-btn');
    const tabLogin = document.getElementById('tab-login');
    const tabRegister = document.getElementById('tab-register');
    const regFields = document.getElementById('register-fields');
    const regAvatar = document.getElementById('register-avatar');

    if (mode === 'login') {
        btn.innerText = "Log In";
        tabLogin.className = "flex-1 py-2 text-sm font-bold rounded-lg bg-zinc-600 text-white transition-all";
        tabRegister.className = "flex-1 py-2 text-sm font-bold rounded-lg text-zinc-400 hover:text-white transition-all";
        regFields.classList.add('hidden');
        regAvatar.classList.add('hidden');
    } else {
        btn.innerText = "Create Profile";
        tabRegister.className = "flex-1 py-2 text-sm font-bold rounded-lg bg-zinc-600 text-white transition-all";
        tabLogin.className = "flex-1 py-2 text-sm font-bold rounded-lg text-zinc-400 hover:text-white transition-all";
        regFields.classList.remove('hidden');
        regAvatar.classList.remove('hidden');
        regAvatar.classList.add('flex');
        
        // CRITICAL: Activate the search box now that it is visible
        setTimeout(attachConditionListeners, 100); 
    }
}

        // --- 3. PREVIEW MAP (Small Static Image) ---
        function initPreview() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((p) => {
                    userLat = p.coords.latitude;
                    userLng = p.coords.longitude;
                    const staticUrl = `https://api.mapbox.com/styles/v1/mapbox/dark-v11/static/${userLng},${userLat},13,0/600x400?access_token=${mapboxgl.accessToken}`;
                    const previewDiv = document.getElementById('static-map-preview');
                    if (previewDiv) {
                        previewDiv.style.backgroundImage = `url('${staticUrl}')`;
                        previewDiv.style.backgroundSize = 'cover';
                        previewDiv.style.opacity = '0.8';
                    }
                });
            }
        }

        // --- 4. ANIMATIONS (Fixed Visibility Bug) ---
        function openMapModal() {
            const card = document.getElementById('care-card');
            const modal = document.getElementById('map-modal');
            const content = document.getElementById('modal-content');
            const rect = card.getBoundingClientRect();

            modal.style.visibility = 'visible'; // CRITICAL FIX
            modal.style.transition = 'none';
            modal.style.top = `${rect.top}px`;
            modal.style.left = `${rect.left}px`;
            modal.style.width = `${rect.width}px`;
            modal.style.height = `${rect.height}px`;
            modal.style.borderRadius = '24px';
            modal.style.opacity = '1';
            modal.style.pointerEvents = 'none';

            modal.offsetHeight; // Force Paint

            modal.style.transition = '';
            requestAnimationFrame(() => {
                modal.style.top = '0px';
                modal.style.left = '0px';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.borderRadius = '0px';
            });

            content.classList.remove('content-hidden');
            content.classList.add('content-visible');

            setTimeout(() => {
                modal.style.pointerEvents = 'auto'; // Unlock Interaction
                initFullMap();
            }, 500);
        }

        function closeMapModal() {
            const card = document.getElementById('care-card');
            const modal = document.getElementById('map-modal');
            const content = document.getElementById('modal-content');
            const rect = card.getBoundingClientRect();

            content.classList.remove('content-visible');
            content.classList.add('content-hidden');

            modal.style.pointerEvents = 'none';
            modal.style.top = `${rect.top}px`;
            modal.style.left = `${rect.left}px`;
            modal.style.width = `${rect.width}px`;
            modal.style.height = `${rect.height}px`;
            modal.style.borderRadius = '24px';

            setTimeout(() => {
                modal.style.opacity = '0';
                modal.style.visibility = 'hidden'; // CRITICAL FIX
            }, 500);
        }

        // --- 5. MAP BUILDER ---
        function initFullMap() {
            if (mapInstance) {
                mapInstance.resize();
                return;
            }
            setTimeout(() => {
                mapInstance = new mapboxgl.Map({
                    container: 'full-map',
                    style: 'mapbox://styles/mapbox/dark-v11',
                    center: [userLng, userLat],
                    zoom: 14,
                    pitch: 45,
                    attributionControl: false
                });

                const el = document.createElement('div');
                el.className = 'user-marker';
                el.style.width = '20px';
                el.style.height = '20px';
                el.style.backgroundColor = '#3b82f6';
                el.style.borderRadius = '50%';
                el.style.border = '3px solid white';
                el.style.boxShadow = '0 0 20px #3b82f6';
                new mapboxgl.Marker(el).setLngLat([userLng, userLat]).addTo(mapInstance);

                mapInstance.on('load', () => {
                    mapInstance.resize();
                    const layers = mapInstance.getStyle().layers;
                    const labelLayerId = layers.find(l => l.type === 'symbol' && l.layout['text-field']).id;
                    mapInstance.addLayer({
                        'id': 'add-3d-buildings',
                        'source': 'composite',
                        'source-layer': 'building',
                        'filter': ['==', 'extrude', 'true'],
                        'type': 'fill-extrusion',
                        'minzoom': 15,
                        'paint': {
                            'fill-extrusion-color': '#222',
                            'fill-extrusion-height': ['get', 'height'],
                            'fill-extrusion-base': ['get', 'min_height'],
                            'fill-extrusion-opacity': 0.8
                        }
                    }, labelLayerId);
                });
            }, 100);
        }

        // --- 6. SEARCH LOGIC ---
        async function searchNearby(category) {
            if (!mapInstance) return;
            const btn = event.currentTarget;
            const originalContent = btn.innerHTML;
            btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin text-white"></i>`;

            if (markers) markers.forEach(m => m.remove());
            markers = [];

            const searchTerm = category === 'hospital' ? 'hospital, clinic' : category;
            const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${searchTerm}.json?proximity=${userLng},${userLat}&types=poi&limit=10&access_token=${mapboxgl.accessToken}`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.features && data.features.length > 0) {
                    const bounds = new mapboxgl.LngLatBounds();
                    data.features.forEach((place) => {
                        const el = document.createElement('div');
                        const colorClass = category === 'hospital' ? 'bg-red-500' : 'bg-blue-500';
                        el.className = `w-4 h-4 rounded-full border-2 border-white shadow-lg ${colorClass}`;
                        const popup = new mapboxgl.Popup({ offset: 25, closeButton: false })
                            .setHTML(`<b style="color:black">${place.text}</b><br><span style="color:#555;font-size:10px">${place.properties?.address || ''}</span>`);
                        const marker = new mapboxgl.Marker(el)
                            .setLngLat(place.center)
                            .setPopup(popup)
                            .addTo(mapInstance);
                        markers.push(marker);
                        bounds.extend(place.center);
                    });
                    mapInstance.fitBounds(bounds, { padding: 80, maxZoom: 15 });
                    addMessage(`Found ${data.features.length} ${category}s nearby.`, false);
                } else {
                    loadUlweBackups(category);
                }
            } catch (error) {
                loadUlweBackups(category);
            }
            btn.innerHTML = originalContent;
        }

        function loadUlweBackups(category) {
            if (category !== 'hospital' && category !== 'clinic') { alert("No results found."); return; }
            const ulweData = [
                { text: "Feather Touch Hospital", center: [73.0280, 18.9745] },
                { text: "Galaxy Hospital", center: [73.0295, 18.9780] },
                { text: "Apollo Clinic", center: [73.0245, 18.9752] },
                { text: "Millennium Hospital", center: [73.0310, 18.9720] }
            ];
            const bounds = new mapboxgl.LngLatBounds();
            ulweData.forEach(place => {
                const el = document.createElement('div');
                el.className = `w-4 h-4 rounded-full border-2 border-white shadow-lg bg-red-500`;
                const popup = new mapboxgl.Popup({ offset: 25, closeButton: false }).setHTML(`<b style="color:black">${place.text}</b><br><span style="color:#555;font-size:10px">Ulwe, Navi Mumbai</span>`);
                const marker = new mapboxgl.Marker(el).setLngLat(place.center).setPopup(popup).addTo(mapInstance);
                markers.push(marker);
                bounds.extend(place.center);
            });
            mapInstance.fitBounds(bounds, { padding: 80, maxZoom: 15 });
            addMessage("Used offline data (Network/API Limit).", false);
        }

        // --- 7. PROFILE & CHAT (Fixed) ---
        function updateUIWithProfile(data) {
            if (data.full_name) {
                document.getElementById('p-name').value = data.full_name;
                const headerName = document.querySelector('h1 span');
                if (headerName) headerName.innerText = data.full_name.split(' ')[0];
            }
            document.getElementById('p-age').value = data.age || '';
            document.getElementById('p-blood').value = data.blood_group || 'Unknown';
            document.getElementById('p-conditions').value = data.conditions || '';
            document.getElementById('p-meds').value = data.medications || '';
            document.getElementById('p-goal').value = data.dietary_goal || '';
            document.getElementById('p-location').value = data.location || '';
        }

        async function saveAndCloseProfile() {
            const btn = event.target;
            btn.innerText = "Saving...";

            const updates = {
                full_name: document.getElementById('p-name').value,
                age: document.getElementById('p-age').value,
                blood_group: document.getElementById('p-blood').value,
                conditions: document.getElementById('p-conditions').value,
                medications: document.getElementById('p-meds').value,
                dietary_goal: document.getElementById('p-goal').value,
                location: document.getElementById('p-location').value
            };

            // SAVE TO LOCAL STORAGE (Guest Mode)
            localStorage.setItem('paws_guest_profile', JSON.stringify(updates));
            updateUIWithProfile(updates);

            setTimeout(() => {
                btn.innerText = "Done";
                toggleProfile(false);
            }, 500);
        }

        async function sendMessage() {
            const inputField = document.getElementById("user-input");
            const message = inputField.value.trim();
            if (message === "") return;

            addMessage(message, true);
            inputField.value = "";

            const mascotText = document.getElementById('mascot-text');
            if (mascotText) mascotText.innerText = "Let me think...";

            try {
                const response = await fetch("https://medipanda-ekck.onrender.com/chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user_message: message })
                });
                const data = await response.json();
                addMessage(data.reply);
                if (mascotText) mascotText.innerText = "I found something!";
            } catch (error) {
                addMessage("I can't reach my brain right now! (Server Error)");
            }
        }

        // --- 8. HELPERS (Navigation, Camera, Etc) ---
        function toggleProfile(show) {
            const modal = document.getElementById('profile-modal');
            const content = modal.querySelector('div');
            if (show) { modal.classList.remove('opacity-0', 'pointer-events-none'); content.classList.remove('translate-y-full'); }
            else { modal.classList.add('opacity-0', 'pointer-events-none'); content.classList.add('translate-y-full'); }
        }

        function formatAIResponse(text) {
            let formatted = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>'); formatted = formatted.replace(/\n/g, '<br>'); formatted = formatted.replace(/^\* /gm, '• '); return formatted;
        }

        function addMessage(text, isUser = false) {
            const container = document.getElementById('chat-container'); const div = document.createElement('div');
            if (isUser) { div.className = "flex items-end justify-end w-full mb-4"; div.innerHTML = `<div class="bg-blue-600 text-white rounded-2xl rounded-tr-none p-4 shadow-md max-w-[85%] fade-enter"><p class="font-bold text-sm leading-relaxed">${text}</p></div>`; }
            else { const cleanHtml = formatAIResponse(text); div.className = "flex items-start w-full mb-4"; div.innerHTML = `<div class="bg-zinc-800 border border-zinc-700 rounded-2xl rounded-tl-none p-4 shadow-sm max-w-[85%] fade-enter text-gray-200 text-sm leading-relaxed"><div>${cleanHtml}</div></div>`; }
            container.appendChild(div); setTimeout(() => { const bubble = div.querySelector('.fade-enter'); if (bubble) bubble.classList.add('fade-enter-active'); }, 10); container.scrollTop = container.scrollHeight;
        }

        function showScreen(screenName) {
            const screens = ['home-screen', 'chat-screen', 'profile-screen'];
            screens.forEach(id => { const el = document.getElementById(id); if (el) el.classList.add('hidden'); });
            const target = document.getElementById(screenName + '-screen'); if (target) target.classList.remove('hidden');
            const navBar = document.querySelector('.fixed.bottom-0'); const island = document.getElementById('dynamic-island'); const profileBtn = document.querySelector('button[onclick="showScreen(\'profile\')"]');
            if (screenName === 'home') { if (navBar) navBar.classList.remove('hidden'); if (island) island.classList.remove('hidden'); if (profileBtn) profileBtn.classList.remove('hidden'); }
            else { if (island) island.classList.add('hidden'); if (profileBtn) profileBtn.classList.add('hidden'); if (screenName === 'profile') { if (navBar) navBar.classList.add('hidden'); } else { if (navBar) navBar.classList.remove('hidden'); } }
        }

        // Camera Globals
        const island = document.getElementById('dynamic-island');
        const icon = document.getElementById('camera-icon');
        const view = document.getElementById('camera-view');
        let isExpanded = false;

        function expandCamera() {
            if (isExpanded) return; isExpanded = true;
            island.style.width = "95%"; island.style.height = "50vh"; island.style.borderRadius = "32px"; island.style.cursor = "default"; icon.style.opacity = "0";
            setTimeout(() => { view.style.opacity = "1"; view.style.pointerEvents = "auto"; document.getElementById('camera-input').click(); }, 300);
        }

        function collapseCamera(e) {
            if (e && typeof e.stopPropagation === 'function') e.stopPropagation(); isExpanded = false;
            if (view) { view.style.opacity = "0"; view.style.pointerEvents = "none"; }
            setTimeout(() => { if (island) { island.style.width = "200px"; island.style.height = "64px"; island.style.borderRadius = "9999px"; island.style.cursor = "pointer"; } if (icon) icon.style.opacity = "1"; }, 100);
        }

        // Camera Input Listener
        const cameraInput = document.getElementById('camera-input');
        if (cameraInput) {
            cameraInput.addEventListener('change', async function (e) {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    const url = URL.createObjectURL(file);
                    const video = document.getElementById('camera-stream');
                    if (video) { video.style.backgroundImage = `url(${url})`; video.style.backgroundSize = "cover"; }
                    setTimeout(() => { collapseCamera(); showScreen('chat'); addMessage("Scanning this image...", true); }, 1000);

                    // Demo Upload Logic
                    const formData = new FormData(); formData.append("file", file); formData.append("user_id", "demo_user");
                    try {
                        const response = await fetch("https://medipanda-ekck.onrender.com/analyze", { method: "POST", body: formData });
                        const data = await response.json();
                        addMessage(data.reply);
                    } catch (error) { addMessage("I couldn't upload the image. Is the server running?"); }
                }
            });
        }
    </script>
    <button onclick="showScreen('chat')"
        class="fixed bottom-12 right-6 z-50 bg-blue-600 hover:bg-blue-500 text-white px-5 py-3 rounded-full shadow-lg font-bold flex items-center gap-2 transition-transform active:scale-95 border border-blue-400/30">
        <i class="fa-solid fa-comment-medical text-lg"></i>
        <span>Ask AI</span>
    </button>
    <div id="map-modal" class="app-transition opacity-0 pointer-events-none bg-[#09090b]">

        <div id="modal-content" class="w-full h-full relative content-hidden">

            <div
                class="absolute top-0 left-0 w-full p-6 pt-12 z-[1001] flex justify-between items-center bg-gradient-to-b from-black/80 to-transparent pointer-events-none">
                <h2 class="text-2xl font-bold text-white drop-shadow-md pointer-events-auto">Nearby Services</h2>
                <button onclick="closeMapModal()"
                    class="bg-black/50 backdrop-blur-md text-white w-10 h-10 rounded-full flex items-center justify-center border border-white/10 pointer-events-auto active:scale-90 transition shadow-lg">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <div id="full-map" class="absolute inset-0 z-0 bg-[#121212]"></div>

            <div class="absolute bottom-8 left-0 w-full px-4 z-[1001] flex justify-center pointer-events-none">
                <div
                    class="bg-zinc-900/90 backdrop-blur-xl border border-white/10 p-3 rounded-3xl shadow-2xl flex gap-3 overflow-x-auto no-scrollbar pointer-events-auto max-w-sm w-full">

                    <button onclick="searchNearby('hospital')"
                        class="flex-1 min-w-[70px] bg-zinc-800/50 hover:bg-zinc-700 text-white py-3 rounded-2xl flex flex-col items-center justify-center gap-1 transition active:scale-95 border border-white/5">
                        <div class="w-8 h-8 rounded-full bg-red-500/20 flex items-center justify-center mb-1"><i
                                class="fa-solid fa-hospital text-red-500 text-sm"></i></div>
                        <span class="text-[10px] font-bold text-zinc-300">Hospitals</span>
                    </button>

                    <button onclick="searchNearby('cardiologist')"
                        class="flex-1 min-w-[70px] bg-zinc-800/50 hover:bg-zinc-700 text-white py-3 rounded-2xl flex flex-col items-center justify-center gap-1 transition active:scale-95 border border-white/5">
                        <div class="w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center mb-1"><i
                                class="fa-solid fa-heart-pulse text-blue-500 text-sm"></i></div>
                        <span class="text-[10px] font-bold text-zinc-300">Cardio</span>
                    </button>

                    <button onclick="searchNearby('pharmacy')"
                        class="flex-1 min-w-[70px] bg-zinc-800/50 hover:bg-zinc-700 text-white py-3 rounded-2xl flex flex-col items-center justify-center gap-1 transition active:scale-95 border border-white/5">
                        <div class="w-8 h-8 rounded-full bg-green-500/20 flex items-center justify-center mb-1"><i
                                class="fa-solid fa-pills text-green-500 text-sm"></i></div>
                        <span class="text-[10px] font-bold text-zinc-300">Meds</span>
                    </button>

                    <button onclick="searchNearby('clinic')"
                        class="flex-1 min-w-[70px] bg-zinc-800/50 hover:bg-zinc-700 text-white py-3 rounded-2xl flex flex-col items-center justify-center gap-1 transition active:scale-95 border border-white/5">
                        <div class="w-8 h-8 rounded-full bg-purple-500/20 flex items-center justify-center mb-1"><i
                                class="fa-solid fa-user-doctor text-purple-500 text-sm"></i></div>
                        <span class="text-[10px] font-bold text-zinc-300">Clinic</span>
                    </button>

                </div>
            </div>
        </div>
    </div>
</body>


</html>