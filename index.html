<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>MediPanda</title>
    <script src="https://cdn.tailwindcss.com">
        const deviceId = "user_" + Math.random().toString(36).substr(2, 9);
        // Generate a unique ID for this phone
        if (!deviceId) {
            deviceId = "user_" + Math.random().toString(36).substr(2, 9);
            localStorage.setItem("paws_device_id", deviceId);
        }
        console.log("My User ID:", deviceId);
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body {
            font-family: "Inter", sans-serif;
        }

        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;
            /* IE and Edge */
            scrollbar-width: none;
            /* Firefox */
        }

        /* The iOS-style Spring Animation */
        .ios-spring {
            transition: all 0.6s cubic-bezier(0.19, 1, 0.22, 1);
            /* Apple's "Spring" curve */
        }

        .fade-enter {
            opacity: 0;
            transform: scale(0.9);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }

        .fade-enter-active {
            opacity: 1;
            transform: scale(1);
        }

        /* --- ADD THESE NEW STYLES INSIDE YOUR EXISTING <style> TAG --- */

        /* 1. Dark Mode Base */
        body {
            background-color: #09090b;
            color: #ffffff;
            /* White text by default */
        }

        /* 2. Apple Music Style Animated Gradients */
        .animated-gradient-1 {
            background: linear-gradient(135deg, #ff4b1f, #ff9068);
            background-size: 200% 200%;
            animation: gradientMove 6s ease infinite;
        }

        .animated-gradient-2 {
            background: linear-gradient(135deg, #8E2DE2, #4A00E0);
            background-size: 200% 200%;
            animation: gradientMove 8s ease infinite;
        }

        @keyframes gradientMove {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        /* 3. Utility to hide scrollbars for a cleaner look */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>

<body class="h-[100dvh] flex flex-col overflow-hidden bg-[#121212]">
    <button onclick="showScreen('profile')"
        class="absolute top-6 right-6 z-50 w-14 h-14 bg-zinc-800 rounded-full shadow-xl flex items-center justify-center active:scale-90 transition-transform border border-zinc-700">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24"
            stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
        </svg>
    </button>

    <div id="profile-modal"
        class="fixed inset-0 bg-black/60 z-[60] backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-300 flex items-end">
        <div
            class="bg-white w-full rounded-t-[32px] p-8 pb-12 translate-y-full transition-transform duration-500 shadow-2xl">
            <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-6"></div>
            <h2 class="text-2xl font-extrabold text-slate-800 mb-2">My Health Profile</h2>
            <p class="text-slate-500 text-sm mb-6">Tell Dr. Paws about allergies or conditions (e.g., "I am diabetic").
            </p>

            <textarea id="medical-input"
                class="w-full bg-slate-100 border-none rounded-2xl p-4 h-32 text-slate-700 placeholder-slate-400 focus:ring-2 focus:ring-blue-500 outline-none transition-all"
                placeholder="Ex: Peanut allergy, high blood pressure..."></textarea>

            <button onclick="saveProfile()"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-2xl mt-6 shadow-lg active:scale-95 transition-all">
                Save Profile
            </button>
            <button onclick="toggleProfile(false)" class="w-full text-slate-400 font-bold py-4 mt-2">Close</button>
        </div>
    </div>

    <div id="dynamic-island"
        class="absolute top-6 left-1/2 -translate-x-1/2 z-50 bg-black shadow-2xl ios-spring overflow-hidden cursor-pointer group"
        style="width: 200px; height: 64px; border-radius: 9999px;" onclick="expandCamera()">

        <div id="camera-icon" class="absolute inset-0 flex items-center justify-center transition-opacity duration-250">
            <svg xmlns="http://www.w3.org/2000/svg"
                class="h-8 w-8 text-white group-hover:scale-110 transition-transform" fill="none" viewBox="0 0 24 24"
                stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        </div>

        <div id="camera-view"
            class="absolute inset-0 opacity-0 pointer-events-none transition-opacity duration-500 delay-100 flex flex-col">

            <div class="absolute top-4 right-4 z-20 bg-black/50 rounded-full p-2 backdrop-blur-md"
                onclick="collapseCamera(event)">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20"
                    fill="currentColor">
                    <path fill-rule="evenodd"
                        d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                        clip-rule="evenodd" />
                </svg>
            </div>

            <video id="camera-stream" autoplay playsinline class="w-full h-full object-cover"></video>

            <div class="absolute bottom-6 w-full text-center">
                <p
                    class="text-white font-medium text-sm bg-black/30 backdrop-blur-md inline-block px-4 py-1 rounded-full border border-white/20">
                    Scanning
                </p>
            </div>
        </div>
    </div>

    <input type="file" id="camera-input" accept="image/*" capture="environment" class="hidden">

    <div id="home-screen" class="flex-1 flex flex-col p-6 space-y-6 overflow-y-auto no-scrollbar pb-32">
        <h1 class="text-3xl font-extrabold mt-20 tracking-tight">Good Evening,<br><span
                class="text-zinc-400">Siddhant</span></h1>
        <div class="grid grid-cols-2 gap-4 h-56">
            <div
                class="animated-gradient-1 rounded-3xl p-5 flex flex-col justify-between shadow-lg relative overflow-hidden">
                <i class="fa-solid fa-bolt absolute top-5 right-5 text-2xl opacity-70"></i>
                <div></div>
                <h2 class="text-2xl font-bold relative z-10 leading-tight">Quick<br>Actions</h2>
            </div>
            <div onclick="openMapModal()"
                class="relative rounded-3xl overflow-hidden shadow-lg border border-zinc-800 bg-zinc-900 h-56 cursor-pointer active:scale-95 transition-transform duration-300 group">

                <div id="static-map-preview"
                    class="absolute inset-0 z-0 opacity-60 grayscale group-hover:grayscale-0 transition-all duration-500">
                </div>

                <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent z-10"></div>

                <div class="relative z-20 h-full p-5 flex flex-col justify-between">
                    <div></div>

                    <div class="flex flex-col">
                        <h2 class="text-white font-bold text-2xl leading-tight tracking-tight">Care &<br>Connect</h2>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-zinc-900 rounded-3xl p-6 h-48 relative overflow-hidden border border-zinc-800 flex items-center">
            <div class="max-w-[65%] z-10">
                <h3 class="font-bold text-xl mb-2 text-white"><i class="fa-solid fa-paw mr-2"></i>Dr. Paws Tip</h3>
                <p class="text-zinc-400 leading-relaxed">"Bamboo is great, but variety is better! Try adding colorful
                    veggies to your next meal."</p>
            </div>
            <img src="https://cdn-icons-png.flaticon.com/512/3769/3769036.png"
                class="absolute -right-6 -bottom-10 w-48 opacity-90 rotate-12 drop-shadow-2xl" alt="Mascot Peeking">
        </div>
    </div>
    <div id="profile-screen" class="hidden h-full flex flex-col bg-[#000000] overflow-y-auto no-scrollbar pb-40">

        <div class="p-6 pt-12 flex justify-between items-center sticky top-0 bg-black/80 backdrop-blur-md z-20">
            <h1 class="text-3xl font-extrabold text-white tracking-tight">Medical ID</h1>
            <button onclick="saveAndCloseProfile()" class="text-blue-500 font-bold text-lg">Done</button>
        </div>

        <div class="flex flex-col items-center mt-2 mb-8">
            <div class="relative group cursor-pointer">
                <div
                    class="w-24 h-24 rounded-full bg-zinc-800 border-2 border-zinc-700 overflow-hidden flex items-center justify-center">
                    <i class="fa-solid fa-user text-4xl text-zinc-500"></i>
                </div>
                <div
                    class="absolute bottom-0 right-0 bg-blue-600 w-8 h-8 rounded-full flex items-center justify-center border-2 border-black">
                    <i class="fa-solid fa-camera text-xs text-white"></i>
                </div>
            </div>
            <button class="mt-3 text-blue-500 text-sm font-medium">Edit Photo</button>
        </div>

        <div class="px-5 space-y-8">

            <div>
                <h3 class="text-zinc-500 text-xs font-bold uppercase ml-4 mb-2">Basic Info</h3>
                <div class="bg-[#1c1c1e] rounded-xl overflow-hidden">
                    <div class="flex items-center justify-between p-4 border-b border-zinc-800">
                        <span class="text-white">Name</span>
                        <input type="text" id="p-name" placeholder="Your Name"
                            class="bg-transparent text-right text-zinc-400 placeholder-zinc-600 outline-none w-1/2 focus:text-blue-500">
                    </div>
                    <div class="flex border-b border-zinc-800">
                        <div class="flex-1 flex items-center justify-between p-4 border-r border-zinc-800">
                            <span class="text-white">Age</span>
                            <input type="number" id="p-age" placeholder="--"
                                class="bg-transparent text-right text-zinc-400 outline-none w-12">
                        </div>
                        <div class="flex-1 flex items-center justify-between p-4">
                            <span class="text-white">Blood</span>
                            <select id="p-blood"
                                class="bg-transparent text-right text-zinc-400 outline-none appearance-none">
                                <option value="Unknown">--</option>
                                <option value="A+">A+</option>
                                <option value="O+">O+</option>
                                <option value="B+">B+</option>
                                <option value="AB+">AB+</option>
                                <option value="A-">A-</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex items-center justify-between p-4 border-b border-zinc-800">
                        <span class="text-white">Height (cm)</span>
                        <input type="number" id="p-height" placeholder="--"
                            class="bg-transparent text-right text-zinc-400 outline-none w-20">
                    </div>
                    <div class="flex items-center justify-between p-4">
                        <span class="text-white">Weight (kg)</span>
                        <input type="number" id="p-weight" placeholder="--"
                            class="bg-transparent text-right text-zinc-400 outline-none w-20">
                    </div>
                </div>
            </div>

            <div>
                <h3 class="text-zinc-500 text-xs font-bold uppercase ml-4 mb-2">Health Conditions</h3>
                <div class="bg-[#1c1c1e] rounded-xl p-4">
                    <textarea id="p-conditions" rows="3"
                        class="w-full bg-transparent text-white placeholder-zinc-600 outline-none resize-none"
                        placeholder="Ex: Type 2 Diabetes, Asthma, Peanut Allergy..."></textarea>
                </div>
            </div>

            <div>
                <h3 class="text-zinc-500 text-xs font-bold uppercase ml-4 mb-2">Active Medications</h3>
                <div class="bg-[#1c1c1e] rounded-xl p-4">
                    <textarea id="p-meds" rows="3"
                        class="w-full bg-transparent text-white placeholder-zinc-600 outline-none resize-none"
                        placeholder="Ex: Metformin (Morning), Insulin (Night)..."></textarea>
                </div>
            </div>

            <div>
                <h3 class="text-zinc-500 text-xs font-bold uppercase ml-4 mb-2">Goals & Location</h3>
                <div class="bg-[#1c1c1e] rounded-xl overflow-hidden">
                    <div class="flex items-center justify-between p-4 border-b border-zinc-800">
                        <span class="text-white">Dietary Goal</span>
                        <input type="text" id="p-goal" placeholder="Lose weight / Gain muscle"
                            class="bg-transparent text-right text-zinc-400 outline-none w-1/2">
                    </div>
                    <div class="flex items-center justify-between p-4">
                        <span class="text-white">Location</span>
                        <input type="text" id="p-location" placeholder="City, Country"
                            class="bg-transparent text-right text-zinc-400 outline-none w-1/2">
                    </div>
                </div>
            </div>

            <p class="text-center text-zinc-600 text-xs px-8">This information is shared with Dr. Paws to provide
                personalized health advice.</p>
        </div>
    </div>
    <div id="chat-screen" class="hidden flex-1 flex flex-col bg-zinc-950">
        <div id="chat-container" class="flex-1 overflow-y-auto p-4 pb-32 space-y-4">
            <div class="flex justify-start">
                <div
                    class="bg-zinc-800 text-gray-200 p-3 rounded-2xl rounded-tl-none max-w-[80%] border border-zinc-700 shadow-sm text-sm">
                    Hello! I'm Dr. Paws. Ask me anything!
                </div>
            </div>
        </div>
        <div class="w-full bg-zinc-900 border-t border-zinc-800 p-4 pb-28">
            <div class="flex items-center gap-3">

                <button onclick="document.getElementById('camera-input').click()"
                    class="text-zinc-400 hover:text-white transition">
                    <i class="fa-solid fa-camera"></i>
                </button>

                <input type="text" id="user-input"
                    class="flex-1 bg-zinc-800 text-white rounded-full px-5 py-3 outline-none border border-zinc-700 focus:border-blue-500 transition placeholder-zinc-500"
                    placeholder="Ask Dr. Paws..." onkeypress="if(event.key === 'Enter') sendMessage()">

                <button onclick="sendMessage()"
                    class="bg-blue-600 text-white w-12 h-12 rounded-full hover:bg-blue-500 transition shadow-lg active:scale-90 flex items-center justify-center flex-shrink-0">
                    <i class="fa-solid fa-paper-plane text-sm"></i>
                </button>
            </div>
        </div>
    </div>
    </div>

    <script>
        // --- 1. GLOBAL VARIABLES (Must be at the top) ---
        const island = document.getElementById('dynamic-island');
        const icon = document.getElementById('camera-icon');
        const view = document.getElementById('camera-view');
        let isExpanded = false;

        // Map Variables
        let mapInstance = null;
        let markersGroup = L.layerGroup(); // Moved to TOP (Fixes the crash)
        let userLat = 19.0330; // Default: Navi Mumbai
        let userLng = 73.0297;

        // --- 2. PROFILE & UI FUNCTIONS ---
        function toggleProfile(show) {
            const modal = document.getElementById('profile-modal');
            const content = modal.querySelector('div');
            if (show) {
                modal.classList.remove('opacity-0', 'pointer-events-none');
                content.classList.remove('translate-y-full');
            } else {
                modal.classList.add('opacity-0', 'pointer-events-none');
                content.classList.add('translate-y-full');
            }
        }

        async function saveAndCloseProfile() {
            const btn = event.target;
            btn.innerText = "Saving...";

            let myId = localStorage.getItem("paws_device_id");
            if (!myId) {
                myId = "user_" + Math.random().toString(36).substr(2, 9);
                localStorage.setItem("paws_device_id", myId);
            }

            const profile = {
                name: document.getElementById('p-name').value,
                age: document.getElementById('p-age').value,
                blood: document.getElementById('p-blood').value,
                conditions: document.getElementById('p-conditions').value
            };

            localStorage.setItem('paws_profile', JSON.stringify(profile));
            if (profile.name) document.querySelector('h1 span').innerText = profile.name;

            const contextString = `Name: ${profile.name}, Age: ${profile.age}, Blood: ${profile.blood}, Conditions: ${profile.conditions}`;

            try {
                const response = await fetch("https://medipanda-ekck.onrender.com/save_profile", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        user_id: myId,
                        medical_context: contextString
                    })
                });

                if (!response.ok) throw new Error(`Server Error: ${response.status}`);
                const data = await response.json();
                if (data.status === "error") throw new Error(data.message);

                btn.innerText = "Saved";
                setTimeout(() => { btn.innerText = "Done"; showScreen('home'); }, 500);

            } catch (e) {
                console.error(e);
                alert(`Saved to phone, but Cloud failed: ${e.message}`);
                showScreen('home');
            }
        }

        // --- 3. CAMERA ANIMATIONS ---
        function expandCamera() {
            if (isExpanded) return;
            isExpanded = true;
            island.style.width = "95%";
            island.style.height = "50vh";
            island.style.borderRadius = "32px";
            island.style.cursor = "default";
            icon.style.opacity = "0";
            setTimeout(() => {
                view.style.opacity = "1";
                view.style.pointerEvents = "auto";
                document.getElementById('camera-input').click();
            }, 300);
        }

        function collapseCamera(e) {
            if (e && typeof e.stopPropagation === 'function') e.stopPropagation();
            isExpanded = false;
            const view = document.getElementById('camera-view');
            const island = document.getElementById('dynamic-island');
            const icon = document.getElementById('camera-icon');

            if (view) { view.style.opacity = "0"; view.style.pointerEvents = "none"; }
            setTimeout(() => {
                if (island) {
                    island.style.width = "200px";
                    island.style.height = "64px";
                    island.style.borderRadius = "9999px";
                    island.style.cursor = "pointer";
                }
                if (icon) icon.style.opacity = "1";
            }, 100);
        }

        // --- 4. CAMERA & CHAT LOGIC ---
        document.getElementById('camera-input').addEventListener('change', async function (e) {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                const url = URL.createObjectURL(file);
                const video = document.getElementById('camera-stream');
                if (video) {
                    video.style.backgroundImage = `url(${url})`;
                    video.style.backgroundSize = "cover";
                }

                setTimeout(() => {
                    collapseCamera();
                    showScreen('chat');
                    addMessage("Scanning this image...", true);
                    const mascotText = document.getElementById('mascot-text');
                    if (mascotText) mascotText.innerText = "Analyzing...";
                }, 1000);

                let myId = localStorage.getItem("paws_device_id");
                if (!myId) {
                    myId = "user_" + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem("paws_device_id", myId);
                }

                const formData = new FormData();
                formData.append("file", file);
                formData.append("user_id", myId);

                try {
                    const response = await fetch("https://medipanda-ekck.onrender.com/analyze", {
                        method: "POST",
                        body: formData
                    });
                    const data = await response.json();
                    addMessage(data.reply);
                    const mascotText = document.getElementById('mascot-text');
                    if (mascotText) mascotText.innerText = "Analysis Complete!";
                } catch (error) {
                    addMessage("I couldn't upload the image. Is the server running?");
                }
            }
        });

        async function sendMessage() {
            const inputField = document.getElementById("user-input");
            const message = inputField.value.trim();
            if (message === "") return;

            addMessage(message, true);
            inputField.value = "";

            const mascotText = document.getElementById('mascot-text');
            if (mascotText) mascotText.innerText = "Let me think...";

            try {
                const response = await fetch("https://medipanda-ekck.onrender.com/chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user_message: message })
                });
                const data = await response.json();
                addMessage(data.reply);
                if (mascotText) mascotText.innerText = "I found something!";
            } catch (error) {
                addMessage("I can't reach my brain right now!");
            }
        }

        // --- 5. MAP LOGIC (Corrected) ---
        function initPreview() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((p) => {
                    userLat = p.coords.latitude;
                    userLng = p.coords.longitude;
                    // Update preview text
                    const locText = document.getElementById('preview-loc-text');
                    if (locText) locText.innerText = "Near You";

                    const previewMap = L.map('static-map-preview', {
                        zoomControl: false,
                        attributionControl: false,
                        dragging: false,
                        scrollWheelZoom: false
                    }).setView([userLat, userLng], 13);
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(previewMap);
                });
            }
        }

        function openMapModal() {
            const modal = document.getElementById('map-modal');
            modal.classList.remove('translate-y-[110%]');

            // Initialize Full Map
            if (!mapInstance) {
                setTimeout(() => {
                    mapInstance = L.map('full-map', {
                        zoomControl: false,
                        attributionControl: false
                    }).setView([userLat, userLng], 14);

                    // Add the Marker Layer Group (This works now because we defined it at the top)
                    markersGroup.addTo(mapInstance);

                    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                        maxZoom: 19,
                        minZoom: 10
                    }).addTo(mapInstance);

                    const userIcon = L.divIcon({
                        className: 'user-marker',
                        html: '<div class="w-4 h-4 bg-blue-500 rounded-full border-2 border-white shadow-[0_0_20px_rgba(59,130,246,0.8)] animate-pulse"></div>',
                        iconSize: [16, 16]
                    });
                    L.marker([userLat, userLng], { icon: userIcon }).addTo(mapInstance);

                    mapInstance.invalidateSize();
                }, 300);
            } else {
                setTimeout(() => {
                    mapInstance.invalidateSize();
                    mapInstance.setView([userLat, userLng], 14);
                }, 300);
            }
        }

        function closeMapModal() {
            const modal = document.getElementById('map-modal');
            modal.classList.add('translate-y-[110%]', 'opacity-0');
            if (mapInstance) {
                setTimeout(() => { mapInstance.invalidateSize(); }, 500);
            }
        }

        // --- ROBUST MAP SEARCH (Live API + Real Ulwe Backup) ---
function searchNearby(category) {
    if (category === 'hospital') {
        const btn = event.currentTarget;
        const originalText = btn.innerHTML;
        btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin text-red-500"></i> Scanning...`;

        markersGroup.clearLayers();

        // 1. Try Live API First
        const query = `
            [out:json][timeout:10]; 
            (
              nwr["amenity"="hospital"](around:5000,${userLat},${userLng});
              nwr["amenity"="clinic"](around:5000,${userLat},${userLng});
            );
            out center;
        `;
        // Using a different, faster mirror server (Kumi Systems) to avoid timeouts
        const url = `https://overpass.kumi.systems/api/interpreter?data=${encodeURIComponent(query)}`;

        // Timeout Promise (fails if API takes > 3 seconds)
        const timeout = new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout")), 3000));

        Promise.race([fetch(url), timeout])
            .then(response => {
                if (!response.ok) throw new Error("Server Error");
                return response.json();
            })
            .then(data => {
                if (data.elements.length > 0) {
                    // SUCCESS: Live Data Found
                    data.elements.forEach(place => {
                        const lat = place.lat || place.center.lat;
                        const lng = place.lon || place.center.lon;
                        const name = place.tags.name || "Medical Center";
                        const isHospital = place.tags.amenity === 'hospital';
                        addRedDot(lat, lng, name, isHospital);
                    });
                    addMessage(`Found ${data.elements.length} nearby centers.`, false);
                    zoomToDots();
                } else {
                    throw new Error("No Data"); // Trigger backup if empty
                }
                btn.innerHTML = originalText;
            })
            .catch(err => {
                // FAILURE: API is down/slow -> Load REAL Ulwe Backups
                console.warn("API Down, loading Ulwe Backup Data...", err);
                loadUlweBackups(); 
                addMessage("Network slow. Showing offline database.", false);
                btn.innerHTML = originalText;
            });

    } else {
        const url = `http://googleusercontent.com/maps.google.com/search?q=${category}/@${userLat},${userLng},14z`;
        window.open(url, '_blank');
    }
}

// --- BACKUP: REAL HOSPITALS IN ULWE (Hardcoded Safety Net) ---
function loadUlweBackups() {
    // These are ACTUAL coordinates for hospitals in Ulwe, Navi Mumbai
    const ulweHospitals = [
        { name: "Feather Touch Hospital", lat: 18.9745, lng: 73.0280, type: true },
        { name: "Galaxy Hospital (Sec 19)", lat: 18.9780, lng: 73.0295, type: true },
        { name: "Apollo Clinic", lat: 18.9752, lng: 73.0245, type: false },
        { name: "Millennium Hospital", lat: 18.9720, lng: 73.0310, type: true },
        { name: "Balaji Hospital", lat: 18.9695, lng: 73.0260, type: true }
    ];

    ulweHospitals.forEach(h => addRedDot(h.lat, h.lng, h.name, h.type));
    zoomToDots();
}

// --- HELPER: Draw Dot ---
function addRedDot(lat, lng, name, isHospital = true) {
    const dot = L.circleMarker([lat, lng], {
        radius: isHospital ? 8 : 6,
        fillColor: isHospital ? '#ef4444' : '#3b82f6',
        color: '#ffffff',
        weight: 2, 
        opacity: 1, 
        fillOpacity: 1
    }).bindPopup(`<b style="color:black">${name}</b>`);
    markersGroup.addLayer(dot);
}

// --- HELPER: Zoom ---
function zoomToDots() {
    if (markersGroup.getLayers().length > 0) {
        markersGroup.addTo(mapInstance);
        const group = L.featureGroup(markersGroup.getLayers());
        mapInstance.flyToBounds(group.getBounds(), { padding: [50, 50], maxZoom: 16 });
    }
}
        // --- 6. NAVIGATION & HELPERS ---
        window.addEventListener('load', initPreview);

        function showScreen(screenName) {
            const screens = ['home-screen', 'chat-screen', 'profile-screen'];
            screens.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
            const target = document.getElementById(screenName + '-screen');
            if (target) target.classList.remove('hidden');

            const navBar = document.querySelector('.fixed.bottom-0');
            const island = document.getElementById('dynamic-island');
            const profileBtn = document.querySelector('button[onclick="showScreen(\'profile\')"]');

            if (screenName === 'home') {
                if (navBar) navBar.classList.remove('hidden');
                if (island) island.classList.remove('hidden');
                if (profileBtn) profileBtn.classList.remove('hidden');
            } else {
                if (island) island.classList.add('hidden');
                if (profileBtn) profileBtn.classList.add('hidden');
                if (screenName === 'profile') {
                    if (navBar) navBar.classList.add('hidden');
                } else {
                    if (navBar) navBar.classList.remove('hidden');
                }
            }
        }

        function formatAIResponse(text) {
            let formatted = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            formatted = formatted.replace(/\n/g, '<br>');
            formatted = formatted.replace(/^\* /gm, 'â€¢ ');
            return formatted;
        }

        function addMessage(text, isUser = false) {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            if (isUser) {
                div.className = "flex items-end justify-end w-full mb-4";
                div.innerHTML = `<div class="bg-blue-600 text-white rounded-2xl rounded-tr-none p-4 shadow-md max-w-[85%] fade-enter"><p class="font-bold text-sm leading-relaxed">${text}</p></div>`;
            } else {
                const cleanHtml = formatAIResponse(text);
                div.className = "flex items-start w-full mb-4";
                div.innerHTML = `<div class="bg-zinc-800 border border-zinc-700 rounded-2xl rounded-tl-none p-4 shadow-sm max-w-[85%] fade-enter text-gray-200 text-sm leading-relaxed"><div>${cleanHtml}</div></div>`;
            }
            container.appendChild(div);
            setTimeout(() => {
                const bubble = div.querySelector('.fade-enter');
                if (bubble) bubble.classList.add('fade-enter-active');
            }, 10);
            container.scrollTop = container.scrollHeight;
        }
    </script>
    <button onclick="showScreen('chat')"
        class="fixed bottom-12 right-6 z-50 bg-blue-600 hover:bg-blue-500 text-white px-5 py-3 rounded-full shadow-lg font-bold flex items-center gap-2 transition-transform active:scale-95 border border-blue-400/30">
        <i class="fa-solid fa-comment-medical text-lg"></i>
        <span>Ask AI</span>
    </button>
    <div id="map-modal"
        class="fixed inset-0 z-[80] bg-[#09090b] translate-y-[110%] transition-transform duration-500 cubic-bezier(0.32,0.72,0,1) flex flex-col">

        <div
            class="absolute top-0 left-0 w-full p-6 pt-12 z-[1001] flex justify-between items-center bg-gradient-to-b from-black/80 to-transparent pointer-events-none">
            <h2 class="text-2xl font-bold text-white drop-shadow-md pointer-events-auto">Nearby Services</h2>
            <button onclick="closeMapModal()"
                class="bg-black/50 backdrop-blur-md text-white w-10 h-10 rounded-full flex items-center justify-center border border-white/10 pointer-events-auto active:scale-90 transition shadow-lg">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>

        <div id="full-map" class="absolute inset-0 z-0 bg-[#121212]"></div>

        <div class="absolute bottom-8 left-0 w-full px-4 z-[1001] flex justify-center pointer-events-none">
            <div
                class="bg-zinc-900/90 backdrop-blur-xl border border-white/10 p-3 rounded-3xl shadow-2xl flex gap-3 overflow-x-auto no-scrollbar pointer-events-auto max-w-sm w-full">

                <button onclick="searchNearby('hospital')"
                    class="flex-1 min-w-[70px] bg-zinc-800/50 hover:bg-zinc-700 text-white py-3 rounded-2xl flex flex-col items-center justify-center gap-1 transition active:scale-95 border border-white/5">
                    <div class="w-8 h-8 rounded-full bg-red-500/20 flex items-center justify-center mb-1">
                        <i class="fa-solid fa-hospital text-red-500 text-sm"></i>
                    </div>
                    <span class="text-[10px] font-bold text-zinc-300">Hospitals</span>
                </button>

                <button onclick="searchNearby('cardiologist')"
                    class="flex-1 min-w-[70px] bg-zinc-800/50 hover:bg-zinc-700 text-white py-3 rounded-2xl flex flex-col items-center justify-center gap-1 transition active:scale-95 border border-white/5">
                    <div class="w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center mb-1">
                        <i class="fa-solid fa-heart-pulse text-blue-500 text-sm"></i>
                    </div>
                    <span class="text-[10px] font-bold text-zinc-300">Cardio</span>
                </button>

                <button onclick="searchNearby('pharmacy')"
                    class="flex-1 min-w-[70px] bg-zinc-800/50 hover:bg-zinc-700 text-white py-3 rounded-2xl flex flex-col items-center justify-center gap-1 transition active:scale-95 border border-white/5">
                    <div class="w-8 h-8 rounded-full bg-green-500/20 flex items-center justify-center mb-1">
                        <i class="fa-solid fa-pills text-green-500 text-sm"></i>
                    </div>
                    <span class="text-[10px] font-bold text-zinc-300">Meds</span>
                </button>

                <button onclick="searchNearby('clinic')"
                    class="flex-1 min-w-[70px] bg-zinc-800/50 hover:bg-zinc-700 text-white py-3 rounded-2xl flex flex-col items-center justify-center gap-1 transition active:scale-95 border border-white/5">
                    <div class="w-8 h-8 rounded-full bg-purple-500/20 flex items-center justify-center mb-1">
                        <i class="fa-solid fa-user-doctor text-purple-500 text-sm"></i>
                    </div>
                    <span class="text-[10px] font-bold text-zinc-300">Clinic</span>
                </button>

            </div>
        </div>
    </div>
</body>


</html>